# 2.1 获取公网IP

> 什么是公网IP？其实我们大部分用户使用的均是大局域网内网网段，大部分情况下，我们所在的小区内仅有几个动态公网IP。

`公网IP != 固定IP`



在我国，公网IP地址和网络等资源，主要是由电信联通移动三大网络运营商，以及一些云计算公司（阿里云，腾讯云，华为云，金山云，青云，Ucloud等）掌握。这些单位是向中国互联网络信息中心申请的。

当然，普通的企业和公司要开展计算机和网络业务，也是可以申请公网IP的（需要向三大运营商申请），由于公网IP的宽带价格非常贵，小型企业，个人用户，家庭用户都用不到。

比如，在阿里云腾讯云等场景中，我们购买云服务器，可以选择购买几个不带公网IP的服务器，组成云上的内网集群应用，数据库，WEB，Nginx 等

这种场景，这些云服务器无法上互联网。无法从互联网下载软件，他们提供的服务也无法被互联网上的用户访问到。 
这种情况下，可以购买弹性公网IP（EIP）和 NAT 网关和SLB等产品。通过这些，可以仅将真正需要对外提供服务的应用（比如http网站）暴露到互联网上。


如果购买不带弹性公网IP的机器，机器会分配一个私网IP，

做为企业用户和个人用户，一般我们要找运营商来申请网络。

综合来看，根据ip地址类型，isp给我们分配大概有三种类型：

- 内网IP： 我们拨号的核心网络设备（路由器或防火墙）上取到的IP是内网IP，比如我司之前取到的100.这种，这种情况一般是由于运营商提供的光猫设备管理拨号

- 动态公网IP：我们核心网络设备（路由器）取到的ip是公网IP，不考虑网站备案，isp恶意封禁等情况下，理论上，我们可以拨号设备上做端口映射后，我们把内部的网站，windows  mstsc，linux openssh等等tcp服务都可以通过这个ip暴露出来，但是这个IP是动态的，运营商可能随时会变更。

- 静态公网ip：这种宽带最好但是价格也是最贵的，有时候也有人叫专线。这个ip归你独享，而且一般上下行对等，一般用于建站，在idc机房内使用。


> NAT 技术，NAT 英文全称是“Network Address Translation”，中文意思是“网络地址转换”。

顾名思义，它是一种把内部私有网络地址（内网IP地址）翻译成合法网络IP地址（公网IP地址）的技术。

这种技术的实现原理就是  在IP数据包通过路由器或防火墙时重写来源 IP 地址或目的 IP 地址的技术。	
（在 IPV4 时代，互联网上的大部分终端，比如我们手机网络，运营商给我们接入的网络都是通过NAT技术接入互联网）
NAT在一定程度上，能够有效的解决公网地址不足的问题。



从终端获取IP地址的地理位置


我们将研究如何 获取我们的公共IP地址的地理位置。 我们将能够通过Ubuntu终端中的开放API和简单的bash脚本来执行此操作。
如今，所有连接到Internet的设备都具有IP，该IP已成为全世界的标识符。 此地址是我们将用来获取您的位置的地址。


当我们上网时， 每个服务器都有一个公共IP地址，它直接分配给服务器，也可以通过将网络流量发送到该服务器的路由器分配。
IP地址提供了一种轻松的方法来跟踪服务器在世界范围内的地理位置。 这可以通过使用以下提供的两个API来实现： ipinfo.io e ipvigilante.com 通过它我们可以获取服务器的国家，城市名称及其地理坐标。

我们将看到 获取我们的公共和私有IP地址 在我们的Ubuntu系统上。 今天，我们连接到Internet的所有设备都具有IP，这已成为全世界的标识符。 
尽管可以通过代理或VPN连接“隐藏”跟踪，但通过Internet上的IP，将记录我们所做的动作。

在网络世界中，我们必须考虑一系列基本术语， 公共或私有IP 他们总是在所有网络管理员的耳中。 IP地址是最基本的概念，但同时也是最重要的概念之一。 请记住 IP是Internet协议的缩写，它已被开发为唯一的数字ID，并以静态和动态方式分配给连接到网络的设备。
今天的地址共存 IPv4（由四个八位位组组成） 如 IPv6（基于128位）。 我们正处于所谓的“过渡”时期，因为有一天我们将只剩下IPv6地址。
连接到互联网的设备具有两种类型的IP地址：
公共IP。 它是我们用来访问Internet的地址，它是一个具有Web服务器或Web上提供的服务的地址。
私人IP。 它是局域网或专用网络的地址，我们可以使用该地址连接同一网络中的计算机或设备。 此地址不是您在Internet上看到的地址。




- **获取公网IP的方式：**

  - 已安装宽带用户：致电给宽带客服咨询。可用策略：`家庭内在装网络监控，安装师傅说要申请公网IP`、

  - 正安装宽带用户：让宽带安装师傅设置光猫桥接，并将宽带账号和密码告知你。`宽带桥接用户较大概率是公网IP`

    <hr>

- **关于公网IP，你需要了解或知悉：**

  1. 现在运营商已经基本不会主动给用户开放IPv4公网地址；
  2. 公网IP每24-72小时`通常48小时`变更一次；（与此相对的是静态公网IP）
  3. 移动宽带`⚠️大内网`基本拿不到公网iP；
  4. 电信宽带较大概率可申请到公网IP，实际看所在地区；
  5. 联通宽带光猫改桥接后（`亲测获得公网IP`）较大概率是公网IP；



### 国内家庭宽带速率的现状

如今家庭宽带已经普及100M宽带，而200M，500M甚至1000M的宽带也慢慢开始在各城市推广上线。根据工信部《工业和信息化部公告》〔2018年第54号〕

> 标准规定：公众用户固定宽带接入业务，当下行小于等于150M时，签约上行接入速率与签约下行接入速率按照最低1：5的比例配置，当下行大于150M时，签约上行速率不低于30M。
从2019年1月1日起生效.

如果你家是电信200M用户，那么理应上行速率为30M，转换为上传速度，理论上满速约为4M/S，外网访问内网在线播放1080P电影实测流畅。

绝大部分宽带运营商为家庭用户提供的宽带为内网模式，即由运营商提供的光猫设备管理拨号和路由服务，而用户只能获取内网IP，同时运营商封闭80/443端口，以至于外网无法更快更便捷的访问到家庭内网中的设备。

目前家庭环境中主流的外网访问内网分公网DDNS和内网穿透两种方式。

公网DDNS是指利用DDNS动态域名解析技术，在外网通过域名访问家庭宽带的公网IP，由路由器提供端口转发，与内网设备直接通讯。

使用公网DDNS直连方式需要满足公网IP，桥接模式，端口映射三个前提，缺一不可。然后利用DDNS动态域名解析技术使用域名访问。


**公网IP**

公网IP是外网访问内网最关键因素。有公网IP，通过端口映射，用户在外网可以和家庭内网的设备直连，速度能达到上行带宽的上限，体验最佳。
内网IP是由运营商光猫获取分配，外网无法与内网设备直连，只能通过内网穿透服务来代理访问内网的设备，然而内网穿透服务依赖于第三方服务器的带宽，所以体验略差。

通过联系运营商，申请开放公网IP，并申请把运营商光猫改为桥接模式，根据提供的宽带账号密码。由用户在自己的路由器或防火墙中设置PPPOE拨号，路由器即取到了获取公网IP。然后通过路由器的端口映射功能，把对公网IP的端口访问转到内部的端口。

端口映射功能，可以将路由器 WAN IP 的一个端口映射到局域网中的一台计算机上(当前的路由器支持IPV4的网络端口映射，暂不支持IPV6）。
当因特网用户访问该 IP 的该端口时（如从因特网实时访问家庭网络摄像头等），路由器将会自动将该请求映射到已指定的计算机上，并通过该计算机对外提供服务。

同时也要注意，如果自己的核心网络设备取到了公网IP，那也一定要注意信息安全，这意味着内网的服务可能会被外网任何人和任何地址访问和扫描，所以有必要重视信息安全工作。

外网访问内网设备的基础是通过IP来通讯，而且运营商提供的公网IP为动态IP，IP地址会定时更变（比如光猫重启等），所以我们需要使用DDNS服务来使域名绑定随时变化的动态公网IP。
DDNS服务是指让公网IP在更变后立即通知域名服务商更变A记录指向到新IP，保证域名指向的持续性，使域名访问不受影响。DDNS大多都是免费提供。
